!-------------TO DO-------------
!Accumulation
!Left Boundary Velocity
!-------------------------------
#
echo off

!! conductivity
$ function conductivity(T)  { _conductivity=9.828*exp(-5.7E-03*T)}
!! capacity
$ function capacity(T) { _capacity=146.3+(7.253*T)}

!! pressuremeltingpoint
$ function pressuremeltingpoint(PIN) {\
  P = PIN;\
  if (P<0.0) P=0.0;\
  beta=9.8E-08*1.0E06;\
  _pressuremeltingpoint=273.15-(beta*P);\
}

check keywords warn

$namerun = "Calving3D"
$restart = "Seasonal_Spinup_Last"

$yearinsec = 365.25*24*60*60

$Rho = 9.03760022565934E-019   !  Ice - 900.0  kg/m3
$RhoFW = 1.00417780285104E-018 !Fresh - 1000.0 kg/m3
$RhoWS = 1.03430313693657E-018 !  Sea - 1030.0 kg/m3
$g = 9.76960357522560E015 !9.81 * yearinsec^2

!Forcing switches
$sikmode = "binary" !"off"
$basalmeltmode = "seasonal" !"off"
$bgmeltmode = "seasonal" !"off"
$plmeltmode = "seasonal" !"off"

!Melt
$BasalMeltSummer = 1516.66 * 0.1 !Alun: 2061.19 * 0.1
$BasalMeltWinter = 853.48 * 0.1 !Alun: 1199.01 * 0.1
$MeltSummerStart = 0.4164
$MeltSummerStop = 0.6658

!For Glens
$GlenN = 3.0

!sikussak stuff
$Sik_mag = 0.12 !<-Toberg, Walter: 0.045
$Sik = Sik_mag*-1.0*470.0
$SikThick = 140 !<-Toberg, Walter: 75.0

!31st Jan (Howat et al)
$sikstart = 0.0849315
!Annual day 149 (Howat et al)
$sikstop = 0.408219

!Calving  -  Dw is depth of water in crevasse (for hydrofracturing)
$Dw = 5.0
$FreeC = 2000.0

$SL = 0.0


Header
  Mesh DB "." "PlanMesh"
  Include Path "include"
  Results Directory "./Results/"
End

Constants
  Water Depth = Real $Dw
  Rho = Real $Rho
  RhoWS = Real $RhoWS
  RhoWF = Real $RhoFW
  g = Real $g

  !TODO
  Buoyancy Use Basal Melt = Logical True
  Bottom Surface Name = String "Zs Bottom"
  Water Density = Real $RhoWS
End

Simulation
  Coordinate System = "Cartesian 3D"
  Simulation Type = Transient

  Timestepping Method = "bdf"
  BDF Order = 1

  Timestep Intervals(1) = 10000
  Output Intervals(1) = 1
  Timestep Sizes(1) = Real 0.01 !$1.0/365.0 !day step

  ! Restart File = "$restart".result" !"
  ! Restart Position = 0
  ! !Restart Time = 0.0
  ! Restart Before Initial Conditions = Logical True !because need beta
  ! Initialize Dirichlet Conditions = Logical False !True
  ! Include "restart_var_list"

  Steady State Max Iterations = 1 !20
  Steady State Min Iterations = 1
  Set Dirichlet BCs By BC Numbering = Logical True
  max output level = 24
  Output Intervals = 1
  Output File = "$namerun".result" !"
  Output Coordinates = Logical True

  Extruded Mesh Levels = Integer 10
  Remesh Extruded Mesh Levels = Integer 10
  ! Extruded Mesh Density = Variable Coordinate 1
  !   Real MATC "0.2+sin(tx*(pi*0.5))"
End

Body 1
  name = All
  Equation = 1
  Material = 1
  Body force = 1
  Initial Condition = 1
End

Body 2
  name = bed
  Equation = 2
  Material = 1
  Body force = 2
  Initial Condition = 2
End

Body 3
  name = "free surface"
  Equation = 3
  Body Force = 3
  Material = 1
  Initial Condition = 3
End

Body 4
  name = "Calving Front"
  Equation = 4
  Body Force = 4
  Material = 1
  Initial Condition = 4
End

Body 5
  name = "cmesh" !The plane mesh used by the Calving3D solver
  Equation = 5
  Material = 1
  Body force = 1
  Initial Condition = 1
End

Body 6
  name = "Inflow"
  Equation = 6
  Body Force = 4
  Material = 1
  Initial Condition = 4
End


Material 1

  Density = Real $ Rho
!----------------
! viscosity stuff
!----------------
  Viscosity Model = String "Glen"
! Viscosity has to be set to a dummy value
! to avoid warning output from Elmer
  Viscosity = Real $1.0E13*yearinsec*1.0E-6
  Glen Exponent = Real 3.0
! Rate factors (Paterson value in MPa^-3a^-1)
  Rate Factor 1 = Real 1.258e13
  Rate Factor 2 = Real 6.046e28
! these are in SI units - no problem, as long as
! the gas constant also is
  Activation Energy 1 = Real 60e3
  Activation Energy 2 = Real 139e3
  Glen Enhancement Factor = Real 1.0

! the variable taken to evaluate the Arrhenius law
! in general this should be the temperature relative
! to pressure melting point. The suggestion below plugs
! in the correct value obtained with TemperateIceSolver
  Temperature Field Variable = String "Temp Homologous"
! the temperature to switch between the
! two regimes in the flow law
  Limit Temperature = Real -10.0
! In case there is no temperature variable
  Constant Temperature = Real -10.0
  Critical Shear Rate = Real 1.0E-10

  ! the heat capacity as a MATC function of temperature itself
  !-----------------------------------------------------------
  Temp Heat Capacity = Variable Temp
  Real MATC "capacity(tx)*(31556926.0)^2"
  ! the heat conductivity as a MATC function of temperature itself
  !--------------------------------------------------------------
  Temp Heat Conductivity = Variable Temp
   Real MATC "conductivity(tx)*(31556926.0)*1.0E-06"
  ! Upper limit - pressure melting point
  !  as a MATC function of the pressure (what else?)
  !-------------------------------------------------
  Temp Upper Limit = Variable Pressure
   Real MATC "pressuremeltingpoint(tx)"
  ! lower limit (to be save) as 0 K
  !--------------------------------
  Temp Lower Limit = Real 0.0
  Sea level = Real $SL

  Cauchy = Logical True
  Youngs Modulus = Real 1.0
  Poisson Ratio = Real 0.3

  Min Zs Top = Variable Coordinate 3, Elevation
      Real MATC "tx(0) - tx(1) + 10.0"

  ! Min Zs Bottom = Variable Coordinate 1
  !   Real Procedure "./bin/USF_Grid2DInterpolator" "BedInterp"

  Min Zs Bottom = Real -500.0
  Sea level = Real $SL
End

!!!!! SOLVERS

Solver 1
  Equation = "MapCoordinate"
  Procedure = "StructuredMeshMapper" "StructuredMeshMapper"
  Exec Solver = "Before Simulation" !If we restart from Output Coordinates = True, don't need this
  Active Coordinate = Integer 3
  Mesh Velocity First Zero = Logical True

  Top Surface Level = Real 100.0
  Bottom Surface Level = Real -500.0
End

Solver 2
  Equation = "Depth"
  Exec Solver = "Before TimeStep"

  Procedure = File "ElmerIceSolvers" "FlowDepthSolver"
  Variable = String "Depth"
  Variable DOFs = 1

  Gradient = Real -1.0E00

  Calc Free Surface = Logical False

  Linear System Solver = Iterative
  Linear System Max Iterations = 300
  Linear System Iterative Method = "BiCGStab"
  Linear System Preconditioning = ILU0
  Linear System Convergence Tolerance = Real 1.0E-6
  Linear System Abort Not Converged = False
  Linear System Residual Output = 1
End

Solver 3
  Equation = "Elevation"
  Exec Solver = "Before TimeStep"

  Procedure = File "ElmerIceSolvers" "FlowDepthSolver"
  Variable = String "Elevation"
  Variable DOFs = 1

  Gradient = Real 1.0E00

  Linear System Solver = Iterative
  Linear System Max Iterations = 300
  Linear System Iterative Method = "BiCGStab"
  Linear System Preconditioning = ILU0
  Linear System Convergence Tolerance = Real 1.0E-6
  Linear System Abort Not Converged = False
  Linear System Residual Output = 0
End

Solver 4
  Equation = "Navier-Stokes"
  Stabilize = Logical True
  Solver Timing = Logical True

  Flow Model = Stokes
  Variable = Flow Solution[Velocity:3 Pressure:1]
!mandatory to save bulk stiffness matrix
  Calculate Loads = Logical True

  Linear System Solver = "Iterative"
  Linear System Iterative Method = "GCR"
  BiCGStabl Polynomial Degree = 4
  Linear System Max Iterations = 500
  Linear System Convergence Tolerance = Real 1.0E-6
  Linear System Abort Not Converged = False
  Linear System Preconditioning = "ILU2"
  Linear System Residual Output = 1

  Nonlinear System Max Iterations = 50
  Nonlinear System Convergence Tolerance = 1.0E-5
  Nonlinear System Newton After Iterations = 100
  Nonlinear System Newton After Tolerance = 0.5E-3
  Nonlinear System Newton Max Tolerance = Real 1.0e-2
  Nonlinear System Newton Max Iterations = Integer 15 !Give up newton
  Nonlinear System Reset Newton = Logical True

  Steady State Convergence Tolerance = Real 1.0e-12

  Update Exported Variables = Logical True
  Nonlinear Update Exported Variables = Logical True

! Define  some usefull Variables
  Exported Variable 1 = Flow Solution Loads[Fx:1 Fy:1 Fz:1 CEQ Residual:1]
  Exported Variable 2 = "Temp Homologous"
End

Solver 5
  Equation = String "Check NS"
  Procedure = File "./bin/Remesh" "CheckFlowConvergence"

  Flow Solver Name = String "Flow Solution"
  Maximum Flow Solution Divergence = Real 1.3
  Maximum Velocity Magnitude = Real 1.0E6
  First Time Max Expected Velocity = Real 8.0E3

  Switch Off Equation 1 = String "StrainSolver"
  Switch Off Equation 2 = String "StressSolver"
  Switch Off Equation 3 = String "3D Calving"
  Switch Off Equation 4 = String "EigenSR"
  Switch Off Equation 5 = String "Free Surface Top"
  Switch Off Equation 6 = String "Free Surface Bottom"
  Switch Off Equation 7 = String "Front Advance"
  Switch Off Equation 8 = String "Longitudinal Mesh Update"
  Switch Off Equation 9 = String "Vertical Mesh Update"
  Switch Off Equation 10 = String "Homologous Temperature Equation"
  Switch Off Equation 11 = String "DeformationalHeat"
  Switch Off Equation 12 = String "Plume"
  Switch Off Equation 13 = String "Basal Melt"
End

Solver 6
  Equation = String "StrainSolver"
  Procedure =  File "ElmerIceSolvers" "ComputeStrainRate"
  Variable = -nooutput "Eij"
  Variable DOFs = 1
  Solver Timing = Logical True
  Exec Intervals = 10

  Exported Variable 1 = "StrainRate"
  Exported Variable 1 DOFs = 7

  Flow Solver Name = String "Flow Solution"

  Linear System Solver = "Iterative"
  Linear System Iterative Method = "BiCGStab"
  Linear System Max Iterations = 300
  Linear System Convergence Tolerance = 1.0E-09
  Linear System Abort Not Converged = False
  Linear System Preconditioning = "ILU0"
  Linear System Residual Output = 0
End

Solver 7
  Equation = String "StressSolver"
  Procedure =  File "ElmerIceSolvers" "ComputeDevStress"
  Solver Timing = Logical True

  ! this is just a dummy, hence no output is needed
  !-----------------------------------------------------------------------
  Variable = -nooutput "Sij"
  Variable DOFs = 1
  ! the name of the variable containing the flow solution(U,V,W,Pressure)
  !-----------------------------------------------------------------------
  Stress Variable Name = String "Stress"
  Flow Solver Name = String "Flow Solution"
  Exported Variable 1 = "Stress" ! [Sxx, Syy, Szz, Sxy] in 2D
				 ! [Sxx, Syy, Szz, Sxy, Syz, Szx] in 3D
  Exported Variable 1 DOFs = 6   ! 4 in 2D, 6 in 3D
  Linear System Solver = "Iterative"
  Linear System Iterative Method = "BiCGStab"
  Linear System Max Iterations = 300
  Linear System Convergence Tolerance = 1.0E-9
  Linear System Abort Not Converged = False
  Linear System Preconditioning = "ILU0"
  Linear System Residual Output = 0
End

Solver 8
   Equation = "Normal vector"
   Variable = "Normal Vector[normal:3]"
   Exec Solver = Before Timestep
   ! in 3dimensional simulations we have 3 entries
   Variable DOFs = 3
   !NB: does not need to actually solve a matrix
   !    hence no BW optimization needed
   Optimize Bandwidth = Logical False
   Procedure = File "ElmerIceSolvers" "ComputeNormalSolver"
   ! if set to True, all boundary normals would be computed by default
   ComputeAll = Logical False
End

Solver 9
!  Exec Solver = "Never"
  Equation = "Save BC Params"
  Procedure = "SaveData" "SaveBoundaryValues"
  Parameter 1 = String "External Pressure"
  Parameter 2 = String "Slip Coefficient 1"
  Parameter 3 = String "Slip Coefficient 2"
  Parameter 4 = String "Slip Coefficient 3"
End

Solver 27
  Equation = "3D Calving"
  Exec Solver = "After Timestep"
  Procedure = "./bin/Calving3D" "Find_Calving3D"
  Solver Timing = Logical True

  Variable = String "Calving"
  Variable DOFs = 3

  Exported Variable 1 = -dofs 1 "CIndex"
  Exported Variable 1 DOFs = 1

  Calving Search Distance = Real 3000.0
  Calving Mesh Min LC = Real 30.0
  Calving Mesh Max LC = Real 100.0
  Calving Mesh LC Min Dist = Real 500.0
  Calving Mesh LC Max Dist = Real 1500.0

  Calving Append Name = String "$namerun"" !"
  Calving Move Mesh Dir = String "./results/"

  Front Orientation(3) = Real -0.9008556490535132 -0.43411876205523897 0.0
  Project Calving Equation Name = String "CalvingProjection"
  Isosurface Equation Name = String "Calving Isosurface"
  Crevasse Penetration Threshold = Real 0.2 !this is the upper limit of average intact ice
  Minimum Calving Event Size = Real 1.0 !minimum front displacement length
  Pause Solvers Minimum Iceberg Volume = Real 1.0E6

  Linear System Solver = Iterative
  Linear System Iterative Method = BiCGStab
  Linear System Max Iterations  = 2000
  Linear System Preconditioning = ILU1
  Linear System Convergence Tolerance = 1.0e-9
  Linear System Abort Not Converged = False
End

Solver 11
  Equation = "EigenSR"
  Variable = -nooutput dumy
  Variable DOFs = 1
  Solver Timing = Logical True

  Procedure = "ElmerIceSolvers" "ComputeEigenValues"

! 3 Eigenvalues
  Exported Variable 1 = "EigenStress"
  EigenValue Variable Name = String "EigenStress"
  Tensor Variable Name = String "Stress"
  Exported Variable 1 DOFS = 3

! Principal vectors (optional)
  Exported Variable 2 = EigenVector1
  Exported Variable 2 DOFS = 3
  Exported Variable 3 = EigenVector2
  Exported Variable 3 DOFS =  3
  Exported Variable 4 = EigenVector3
  Exported Variable 4 DOFS = 3
End

Solver 12
  Equation = Distance
  Exec Solver = "Before Timestep"
  Procedure = "DistanceSolve" "DistanceSolver1"
  Variable = "Distance"
  Solver Timing = Logical True

  Nonlinear System Max Iterations = 200
  Nonlinear System Convergence Tolerance = 1.0e-5

  Linear System Solver = Iterative
  Steady State Convergence Tolerance = 1.0e-4
End

Solver 14
  Equation = "CalvingResultOutput"
  Procedure = File "ResultOutputSolve2" "ResultOutputSolver"
  Exec Solver = "Never"

  Output File Name  = "plane_$namerun"_" !"
  Vtu Format = logical true
  Binary Output = True
  Single Precision = True
  Save Geometry IDs = True

!  Scalar Field 1 = "ave_cindex"
End

Solver 15
  Equation = "CalvingProjection"
  Procedure = File "./bin/ProjectCalving" "ProjectCalving"
  Exec Solver = "Never"
  Solver Timing = Logical True

  Basal Crevasse Model = Logical True
  Surface Crevasse Model = Logical True

  Calving Stress Variable Name = String "Stress"
  Plane Permutation(3) = Integer 1 3 2
  Volume Permutation(3) = Integer 1 3 2
End

Solver 19
  Equation = "Free Surface Top"
  Variable = "Zs Top"
  Exec Solver = "After Timestep"
  Variable DOFs =  1
  Procedure =  "FreeSurfaceSolver" "FreeSurfaceSolver"
  Solver Timing = Logical True

!  Before Linsolve = "EliminateDirichlet" "EliminateDirichlet"

  Linear System Solver = Iterative
  Linear System Max Iterations = 1500
  Linear System Iterative Method = BiCGStab
  Linear System Preconditioning = ILU4
  Linear System Convergence Tolerance = Real 1.0e-12
  Linear System Abort Not Converged = False
  Linear System Residual Output = 1

  Nonlinear System Max Iterations = 100
  Nonlinear System Min Iterations = 2 !needed for dirichlet min fs condition
  Nonlinear System Convergence Tolerance  = 1.0e-6

  Steady State Convergence Tolerance = 1.0e-03

  Stabilization Method = Bubbles
  Apply Dirichlet = Logical True

  ALE Formulation = Logical True
  Maximum Displacement = Real 20.0

  Exported Variable 1 = "Zs Top Residual"
  Exported Variable 1 DOFs = 1
  Exported Variable 2 = "Reference Zs Top"
  Exported Variable 2 DOFs = 1
  Exported Variable 3 = Zs Top Accumulation Flux
  Exported Variable 3 DOFs = 3
  Exported Variable 4 = "smb"

  Update Exported Variables = Logical True
  Nonlinear Update Exported Variables = Logical True
  Calculate Loads = Logical True
End

Solver 21
  Equation = "Free Surface Bottom"
  Variable = "Zs Bottom"
  Exec Solver = "After Timestep"
  Variable DOFs =  1
  Procedure =  "FreeSurfaceSolver1" "FreeSurfaceSolver"
  Solver Timing = Logical True

!  Before Linsolve = "EliminateDirichlet" "EliminateDirichlet"

  Linear System Solver = Iterative
  Linear System Max Iterations = 1500
  Linear System Iterative Method = BiCGStab
  Linear System Preconditioning = ILU4
  Linear System Convergence Tolerance = Real 1.0e-12
  Linear System Abort Not Converged = False
  Linear System Residual Output = 1

  Nonlinear System Max Iterations = 100
  Nonlinear System Min Iterations = 2 !needed for dirichlet min fs condition
  Nonlinear System Convergence Tolerance  = 1.0e-6

  Steady State Convergence Tolerance = 1.0e-03

  Stabilization Method = Bubbles
  Apply Dirichlet = Logical True

  ALE Formulation = Logical True

  Exported Variable 1 = "Zs Bottom Residual"
  Exported Variable 1 DOFs = 1
  Exported Variable 2 = "Reference Zs Bottom"
  Exported Variable 2 DOFs = 1
  Exported Variable 3 = Zs Bottom Accumulation Flux
  Exported Variable 3 DOFs = 3

  Update Exported Variables = Logical True
  Nonlinear Update Exported Variables = Logical True
  Calculate Loads = Logical True
End

Solver 17
  Equation = "Front Advance"
  Procedure =  File "./bin/FrontAdvance3D" "FrontAdvance3D"
  Exec Solver = "After Timestep"
  Variable = -dofs 3 "FrontAdvance"

  Normal Vector Variable Name = String "Front Normal Vector"
  Flow Solution Variable Name = String "Flow Solution"
  Melt Variable Name = String "MeltRate"

  !regions exceeding this gradient will be modified/checked
  Front Gradient Threshold = Real 5.0
  Front Projectability Epsilon = Real 1.0
  Column Max Longitudinal Range = Real 350.0
  Maximum Node Displacement = Real 1.0E4

  Front Orientation(3) = Real -0.9008556490535132 -0.43411876205523897 0.0

  Exported Variable 1 = "Tangled"
End

Solver 18
  Equation = "Longitudinal Mesh Update"
  ! usually, the solver is executed only after the thermo-mechanical
  ! problem has obtained a solution on the time-level
  Procedure =  File "MeshSolve" "MeshSolver"
  Exec Solver = "After Timestep"
  Solver Timing = Logical True

  Variable = Longitudinal Mesh Update
  Variable DOFs = 3
  Linear System Solver = Iterative
  Linear System Iterative Method = BiCGStab
  Linear System Max Iterations  = 500
  Linear System Preconditioning = ILU1
  Linear System Convergence Tolerance = 1.0e-12
  Linear System Abort Not Converged = False
  Nonlinear System Max Iterations = 1
  Nonlinear System Convergence Tolerance = 1.0e-06
End


Solver 22
  Equation = "Vertical Mesh Update"
  ! usually, the solver is executed only after the thermo-mechanical
  ! problem has obtained a solution on the time-level
  Exec Solver = "After Timestep"
  Procedure =  File "MeshSolve1" "MeshSolver"
  Solver Timing = Logical True

  Variable = Vertical Mesh Update
  Variable DOFs = 3
  Linear System Solver = Iterative
  Linear System Iterative Method = BiCGStab
  Linear System Max Iterations  = 2000
  Linear System Preconditioning = ILU1
  Linear System Convergence Tolerance = 1.0e-12
  Linear System Abort Not Converged = False
  Nonlinear System Max Iterations = 3
  Nonlinear System Convergence Tolerance = 1.0e-06
End

Solver 24
  Exec Solver = Before All
  Equation = "GroundedMask Initialization"
  Variable = "GroundedMask"
  Variable DOFs = 1
  Procedure = "ElmerIceSolvers" "GroundedSolver"
  ! Give a tolerance for the bedrock
  Toler = Real 1.0e-03

  ! DEFAULT: Bedrock is read in the material parameter "Min Zs Bottom"
  !! OR Use this keyword if the bedrock is given as a variable
  ! Bedrock Variable = String "bedrock"
  !! OR use this keyword if the bedrock is given as a material parameter
  ! Bedrock Material = String "Min Zb"
End

Solver 23
  Exec Solver = "After Timestep"
  Equation = "GroundedMask"
  Variable = "GroundedMask"
  Variable DOFs = 1
  Procedure = "ElmerIceSolvers" "GroundedSolver"
  ! Give a tolerance for the bedrock
  Toler = Real 1.0e-03

  ! DEFAULT: Bedrock is read in the material parameter "Min Zs Bottom"
  !! OR Use this keyword if the bedrock is given as a variable
  ! Bedrock Variable = String "bedrock"
  !! OR use this keyword if the bedrock is given as a material parameter
  ! Bedrock Material = String "Min Zb"
End

!This turns the BC 'External Pressure' into hydrostatic loads
Solver 13
  Equation = Fw
  Procedure = "ElmerIceSolvers" "GetHydrostaticLoads"
  Exec Solver = "Before Timestep"
  Variable = Fw[Fwater:3]
  Variable DOFs = 3
End

Solver 20
  Equation = "Initialize Rotated FreeSurface"
  Procedure = "FreeSurfaceSolver" "FreeSurfaceSolver_RotInit"
  Variable = "Reference Zs Front"
  Exec Solver = "Never"
!  No Matrix = Logical True

  Free Surface Variable Name = String "Zs Front"
  Zs Front Orientation(3) = Real -0.9008556490535132 -0.43411876205523897 0.0
End

Solver 26
  Exec Solver = String "Never"
  Equation = String "Homologous Temperature Equation"
  Procedure =  File "ElmerIceSolvers" "TemperateIceSolver"
  Loop While Unconstrained Nodes = Logical True
  Solver Timing = Logical True

  ! Comment next line in parallel, as EliminateDirichlet does
  ! not work in parallel
  !------------------------------------------------------------
!  Before Linsolve = "EliminateDirichlet" "EliminateDirichlet"
  Variable = String "Temp"
  Variable DOFs = 1
  Linear System Solver = "Iterative"
  Linear System Iterative Method = "BiCGStab"
!  BiCGStabl Polynomial Degree = 4
  Linear System Max Iterations = 500
  Linear System Convergence Tolerance = 1.0E-07
  Linear System Abort Not Converged = False
  Linear System Preconditioning = ILU2
  Linear System Residual Output = 1
  Steady State Convergence Tolerance = 1.0E-04
  Nonlinear System Convergence Tolerance = 1.0E-05
  Nonlinear System Max Iterations = 50
  Nonlinear System Relaxation Factor = Real 9.999E-01
  ! uses the contact algorithm (aka Dirichlet algorithm)
  !-----------------------------------------------------
  Apply Dirichlet = Logical True
  Stabilize = True
  VectH = Logical True

  Flow Solver Name = String "Flow Solution"
  Flow Loads Name = String "Flow Solution Loads"
  ! those two variables are needed in order to store
  ! the relative or homologous temperature as well
  ! as the residual
  !-------------------------------------------------
  Exported Variable 1 = String "Temp Homologous"
  Exported Variable 1 DOFs = 1
  Exported Variable 2 = String "Temp Residual"
  Exported Variable 2 DOFs = 1
End

Solver 25
  Equation = DeformationalHeat
  Exec Solver = "Never"
  Variable = W
  Variable DOFs = 1
  Solver Timing = Logical True

  procedure =  "ElmerIceSolvers" "DeformationalHeatSolver"

  Linear System Solver = Iterative

  Flow Solver Name = String "Flow Solution"
End

Solver 37
  Exec Solver = String "After Timestep"
  Equation = "Save Mesh"
  Procedure = "SaveMesh" "SaveMesh"
  Variable = "-global -nooutput SaveMeshDummy"
  Save Mesh = Logical True
  Mesh Name = "$namerun"_out" !"
  Save Mesh Directory = String "./results/"
  Save All Timesteps = Logical True
End

Solver 32
  Exec Solver = after timestep
  Procedure = File "SaveData" "SaveMaterials"
  Parameter 1 = String Min Zs Bottom
End

Solver 29
   Equation = "Remesh"
   Procedure = "./bin/Remesh" "Remesher"
   Exec Solver = "After Timestep"
   Solver Timing = Logical True
   Variable = "RemeshHeight"

   Non-Vertical Face Name = String "Calving Front"
   Mesh Update Helper Variable = String "Remesh Update"
   Map Coordinate Equation Name = String "Remesh Map Coordinate"
   Front Orientation(3) = Real -0.9008556490535132 -0.43411876205523897 0.0
   Remesh Vertical Stretch = Real 10000.0
   Vertical Front Computation = String "midrange"
   Metis Algorithm = Integer 1
   Pseudo SS dt = Real 1.0e-10 !timestep size after calving
   Force Remesh After Time = Real 0.1
   Front Normal Z Threshold = Real -0.8
   Pause After Calving Event = Logical True !pause, recompute stress, check for more calving

   Linear System Solver = Iterative
   Linear System Iterative Method = BiCGStab
   Linear System Max Iterations  = 2000
   Linear System Preconditioning = ILU1
   Linear System Convergence Tolerance = 1.0e-9
   Linear System Abort Not Converged = False

   Remesh Min Distance Threshold = Real 800.0 !Nodes closer have Min Char Len
   Remesh Max Distance Threshold = Real 20000.0 !Nodes further have Max Char Len
   Remesh Min Characteristic Length = Real 100.0 !Min Char Len
   Remesh Max Characteristic Length = Real 2000.0 !Max Char Len
   Remesh Default Characteristic Length = Real 2000.0 !Default (nodal) Char Len
   Remesh Remove Nodes Closer Than = Real 55.0
   Remesh Remove Nodes Deviation Threshold = Real 10.0

   Remesh Max Displacement Gradient = Real 5.0
   Remesh Displacement Deviation Limit = Real 50.0

   Tangled Variable Name = String "Tangled"

   Remesh Append Name = String "$namerun"" !"
   Remesh Move Mesh Dir = String "./results/"

   !We need to mess with these solvers if there's a calving event
   Mesh Update Variable 1 = String "Vertical Mesh Update"
   Mesh Update Variable 2 = String "Longitudinal Mesh Update"

   FreeSurface Variable 1 = String "Zs Top"
   FreeSurface Variable 2 = String "Zs Bottom"
   ! FreeSurface Variable 3 = String "Zs Front"
   ! FreeSurface Variable 3 Rotated = Logical True

   Switch Off Equation 1 = String "Homologous Temperature Equation"
   Switch Off Equation 2 = String "Plume"
   Switch Off Equation 3 = String "Basal Melt"
   Switch Off Equation 4 = String "Front Advance"
End

Solver 30
  Equation = "Remesh Mesh Update"
  Procedure = File "MeshSolve2" "MeshSolver"
  Exec Solver = "Never" !we don't want it called automatically
  Solver Timing = Logical True

  Variable = Remesh Update
  Variable DOFs = 3
  Exported Variable 1 = RemeshTopSurf
  Exported Variable 2 = RemeshBottomSurf

  Linear System Solver = Iterative
  Linear System Iterative Method = BiCGStab
  Linear System Max Iterations  = 2000
  Linear System Preconditioning = ILU1
  Linear System Convergence Tolerance = 1.0e-12
  Linear System Abort Not Converged = False
  Nonlinear System Max Iterations = 3
  Nonlinear System Convergence Tolerance = 1.0e-06

  Compute Mesh Velocity = Logical False
  Ignore Displacement = Logical True
End

Solver 31
  Equation = "Remesh Map Coordinate"
  Procedure = "StructuredMeshMapper" "StructuredMeshMapper"
  Exec Solver = "Never"
  Auxiliary Solver = Logical True
  Active Coordinate = Integer 3
  Mesh Velocity First Zero = Logical True
  Always Detect Structure = Logical True
End

Solver 38
  Equation = "ResultOutput"
  Procedure = File "ResultOutputSolve3" "ResultOutputSolver"
  Exec Solver = "After Timestep"

  Output File Name  = "$namerun"_" !"
  Vtu Format = logical true
  Binary Output = True
  Single Precision = True
  Save Geometry IDs = True

  Vector Field 1 = "Velocity"
  Vector Field 2 = "Normal Vector"
  Vector Field 3 = "Stress"
  Vector Field 4 = "StrainRate"
  Vector Field 5 = "Flow Solution Loads"

  Scalar Field 1 = "beta"
  Scalar Field 2 = "Distance"
  Scalar Field 3 = "Pressure"
  Scalar Field 4 = "GroundedMask"
  Scalar Field 5 = "Fw"
  Scalar Field 6 = "Temp"
  Scalar Field 7 = "Temp Homologous"
  Scalar Field 8 = "Slip Coefficient 1"
  Scalar Field 9 = "Slip Coefficient 2"
  Scalar Field 10 = "Slip Coefficient 3"
  Scalar Field 11 = "Zs Bottom"
  Scalar Field 12 = "Reference Zs Bottom"
  Scalar Field 13 = "Zs Front"
  Scalar Field 14 = "Reference Zs Front"
  Scalar Field 15 = "External Pressure"

End

Solver 33
  Exec Solver = "Never"
  Equation = "Calving Isosurface"
  Procedure = File "Isosurface" "IsosurfaceSolver"

  Isosurface Variable = String "ave_cindex"
  Isosurface Value = Real 0.0
End

Solver 28
  Equation = "ResultOutputPreCalve"
  Procedure = File "ResultOutputSolve1" "ResultOutputSolver"
  Exec Solver = "After Timestep"
!  Exec Solver = "Never"

  Output File Name  = "$namerun"_precalve" !"
  Vtu Format = logical true
  Binary Output = True
  Single Precision = True
  Save Geometry IDs = True

  Vector Field 1 = "Velocity"
  Vector Field 2 = "Normal Vector"
  Vector Field 3 = "Stress"
  Vector Field 4 = "EigenStress"
  Vector Field 5 = "StrainRate"
  Vector Field 6 = "Flow Solution Loads"
  Vector Field 7 = "Mesh Velocity"
  Vector Field 8 = "Longitudinal Mesh Update"
  Vector Field 9 = "Calving"
  Vector Field 10 = "Front Normal Vector"
  Vector Field 11 = "FrontAdvance"

  Scalar Field 1 = "beta"
  Scalar Field 2 = "Distance"
  Scalar Field 3 = "Pressure"
  Scalar Field 4 = "GroundedMask"
  Scalar Field 5 = "Fw"
  Scalar Field 6 = "Temp"
  Scalar Field 7 = "Temp Homologous"
  Scalar Field 8 = "Slip Coefficient 1"
  Scalar Field 9 = "Slip Coefficient 2"
  Scalar Field 10 = "Slip Coefficient 3"
  Scalar Field 11 = "Reference Zs Bottom"
  Scalar Field 12 = "Zs Bottom"
  Scalar Field 13 = "smb"
  Scalar Field 14 = "Reference Zs Front"
  Scalar Field 15 = "Zs Front"
  Scalar Field 16 = "Vertical Mesh Update 3"
  Scalar Field 17 = "MeltRate"
  Scalar Field 18 = "Depth"
  Scalar Field 19 = "Elevation"
  Scalar Field 20 = "External Pressure"
  Scalar Field 21 = String "BasalMeltRate"
  Scalar Field 22 = String "Tangled"
  Scalar Field 23 = String "Toe Calving"
End

Solver 34
  Equation = Reader
  Exec Solver = String "Before Timestep"
  Procedure = "GridDataReader" "GridDataReader"
  Solver Timing = Logical True

  !---- NOTE: File is case sensitive, String is not!
  Filename = File "./annual_velocity.nc"

  X Dim Name = String "x"
  Y Dim Name = String "y"

  X Var Name = String "x"
  Y Var Name = String "y"

  !--- Interpolation variables
  X Epsilon = Real 1.0e-2
  Y Epsilon = Real 1.0e-2

  Interpolation Bias = Real 0.0
  Interpolation Multiplier = Real 1.0

  Variable 1 = vx
  Variable 2 = vy
  Variable 3 = vmag

  Enable Scaling = Logical False ! Scales the Elmer grid to match the NetCDF grid

End

Solver 35
  Equation = Reader2
  Exec Solver = String "Before Timestep"
  Procedure = "GridDataReader2" "GridDataReader"
  Solver Timing = Logical True

  !---- NOTE: File is case sensitive, String is not!
  Filename = File "./body_temp.nc"

  X Dim Name = String "x"
  Y Dim Name = String "y"
  Z Dim Name = String "z"

  X Var Name = String "x"
  Y Var Name = String "y"
  Z Var Name = String "z"

  !--- Interpolation variables
  X Epsilon = Real 1.0e-2
  Y Epsilon = Real 1.0e-2
  Z Epsilon = Real 1.0e-2

  Interpolation Bias = Real 0.0
  Interpolation Multiplier = Real 1.0
  Out Of Bounds Retain Previous Value = Logical True

  Variable 1 = "temperature"
  Target Variable 1 = "Temp"
  Enable Scaling = Logical False ! Scales the Elmer grid to match the NetCDF grid
End

Solver 36
  Equation = Reader3
  Exec Solver = String "Before Timestep"
  Procedure = "GridDataReader3" "GridDataReader"
  Solver Timing = Logical True

  !---- NOTE: File is case sensitive, String is not!
  Filename = File "./seasonal_beta.nc"

  X Dim Name = String "x"
  Y Dim Name = String "y"
  Time Dim Name = String "time"

  X Var Name = String "x"
  Y Var Name = String "y"
  Time Var Name = String "time"

  !--- Interpolation variables
  X Epsilon = Real 1.0e-2
  Y Epsilon = Real 1.0e-2
  Time Epsilon = Real 1.0e-10

  Interpolation Bias = Real 0.0
  Interpolation Multiplier = Real 1.0

  Time Point = Variable Time
    Real MATC "((tx - floor(tx)) * 20.0) + 1.0"
!  Is Time Counter = Logical True
  Is Time Index = Logical True

  Variable 1 = "beta"

  Enable Scaling = Logical False ! Scales the Elmer grid to match the NetCDF grid
End

!REMOVE
Solver 10
  Equation = "Plume"
  Procedure = File "./bin/Plume" "Plume"
  Exec Solver = "After Timestep"

  Variable = "MeltRate"
  Front Orientation(3) = Real -0.9008556490535132 -0.43411876205523897 0.0

  Melt Stats File = String "$namerun"_meltstats.txt" !"

  Force Toe Calving = Logical True
  Exported Variable 1 = "Toe Calving"

  Background Melt Mode = String $bgmeltmode
  Background Melt From File = Logical True
  !NB: can be seasonally constant, just point to the same file twice...
  !NB2: should be melt rate in time units (in this case, years)
  !NB3: if changing these files, change basal melt too!
  Background Melt Summer Input File = File "bmelt_summer_profile.dat"
  Background Melt Winter Input File = File "bmelt_winter_profile.dat"
  Background Melt Summer Start = Real $MeltSummerStart
  Background Melt Summer Stop = Real $MeltSummerStop

  ! Background Melt Max = Real $BGMelt
  ! Background Melt Max Melt Elevation = Real $BGMME
  ! Background Melt DmDz = Real $BGDmDz

  Plume Melt Mode = String $plmeltmode
  Plume Count = Integer 2
  Plumes From File = Logical True

  Plume 1 X = Real -209926.0
  Plume 1 Y = Real -2134749.0
  Plume 1 Input File = File "conical_plume_profile.dat"
  Plume 1 Start Times(1) = Real $MeltSummerStart
  Plume 1 Stop Times(1) = Real $MeltSummerStop
  ! Plume 1 DwDz = Real 0.249
  ! Plume 1 Initial Width = Real 10.0
  ! Plume 1 DmDz = Real $P1_dmdz
  ! Plume 1 Max Melt Rate = Real $P1_MMR
  ! Plume 1 Max Melt Elevation = Real 75.0

  Plume 2 X = Real -208633.0
  Plume 2 Y = Real -2136276.0
  Plume 2 Input File = File "conical_plume_profile.dat"
  Plume 2 Start Times(1) = Real $MeltSummerStart
  Plume 2 Stop Times(1) = Real $MeltSummerStop
  ! Plume 2 DwDz = Real 0.249
  ! Plume 2 Initial Width = Real 10.0
  ! Plume 2 DmDz = Real $P2_dmdz
  ! Plume 2 Max Melt Rate = Real $P2_MMR
  ! Plume 2 Max Melt Elevation = Real 75.0
End

!Remove
Solver 16
  Equation = "Basal Melt"
  Procedure = File "./bin/BasalMelt3D" "BasalMelt3D"
  Exec Solver = "After Timestep"

  Variable = "BasalMeltRate"
  Basal Melt Stats File = String "$namerun"_basalmeltstats.txt" !"
  GroundedMask Variable = String "GroundedMask"
  !NOTE: These are set as the max value in the planar melt rate files
  !If these files were updated, these values should be too.
  Basal Melt Mode = String $basalmeltmode
  Basal Melt Summer Rate = Real $BasalMeltSummer
  Basal Melt Winter Rate = Real $BasalMeltWinter
  Basal Melt Summer Start = Real $MeltSummerStart
  Basal Melt Summer Stop = Real $MeltSummerStop
End

!Remove??
Solver 39
  Equation = "Front Normal"
  Procedure =  File "./bin/FrontComputeNormal" "FrontComputeNormalSolver"
  Exec Solver = "Before Timestep"

  Variable = -dofs 3 "Front Normal Vector"
End

!!!!! EQUATION

Equation 1 !Main body
   Active Solvers (24) = 1 2 3 4 5 6 7 8 9 11 12 28 14 18 25 26 29 22 37 30 31 38 32 35
   Convection = Computed
   Flow Solution Name = String "Flow Solution"
End

Equation 2 !Bed
   Active Solvers(6) = 13 16 21 23 24 36
   Convection = Computed
   Flow Solution Name = String "Flow Solution"
End

Equation 3 !Upper Surface
   Active Solvers(1) = 19
   Element = "p:%-"
   Convection = Computed
   Flow Solution Name = String "Flow Solution"
End

Equation 4 !Calving front
   Active Solvers(5) = 10 17 20 27 39
   Convection = Computed
   Flow Solution Name = String "Flow Solution"
End

Equation 5 !cmesh - the planar mesh used by 3D calving solver
   Active Solvers(2) = 15 33
   Convection = Computed
End

Equation 6
  Active Solvers = 34
End
!!!!! BOUNDARY CONDITIONS

Boundary Condition 1
  name = "Calving Front"
  Calving Front Mask = Logical True
  Target Boundaries = 1
  Body ID = 4

  Distance = Real 0.0
  Flow Force BC = Logical True

  !Gives the total of sea pressure + sikussak when applicable
  External Pressure = Variable Coordinate 1 !dummy
    Real Procedure "ElmerIceUSF" "SeaPressure"

  Sikussak Mode = String $sikmode !Constant, Seasonal, Binary, Off
  Sikussak Backstress = Real $Sik
  Sikussak Thickness = Real $SikThick

  Sikussak Form Season = Real $sikstart
  Sikussak Clear Season = Real $sikstop

  !These mesh update values are zeroed internally by Remesh
  !So their value is *not* cumulative
  ! Longitudinal Mesh Update 1 = Variable Zs Front, Reference Zs Front
  !    Real Procedure "FreeSurfaceSolver" "FreeSurfaceToMeshUpdate1"
  ! Longitudinal Mesh Update 2 = Variable Zs Front, Reference Zs Front
  !    Real Procedure "FreeSurfaceSolver" "FreeSurfaceToMeshUpdate2"

  Longitudinal Mesh Update 1 = Equals FrontAdvance 1
  Longitudinal Mesh Update 2 = Equals FrontAdvance 2
  Longitudinal Mesh Update 3 = Equals FrontAdvance 3

  !Not physically important, internal to Remeshing
  Remesh Update 3 = Variable Coordinate 3, FrontExtent
    Real MATC "tx(1) - tx(0)"
End

Boundary Condition 2
  name = "Inflow"
  Inflow Mask = Logical True
  Target Boundaries = 3

  Body ID = 6

  Flow Force BC = Logical True

  Velocity 1 = Equals vx
  Velocity 2 = Equals vy

  ! Temp = Variable Coordinate 1
  !   Real Procedure "./bin/USF_Grid2DInterpolator" "TempInterp"
  ! Include "temp.xyz.header"

  Longitudinal Mesh Update 1 = Real 0.0
  Longitudinal Mesh Update 2 = Real 0.0
  Longitudinal Mesh Update 3 = Real 0.0

  Zs Top = Equals Reference Zs Top
  Zs Bottom = Equals Reference Zs Bottom

  Remesh Update 3 = Real 0.0
End

Boundary Condition 3

  name = "Sidewalls"
  Right Sidewall Mask = Logical True
  Target Boundaries = 2
  Flow Force BC = Logical True

  Normal-Tangential Velocity = Logical True
  Normal-Tangential Flow Solution = Logical True
  Mass Consistent Normals = Logical True

  Velocity 1 = Real 0.0
  ! Velocity 1 Condition = Variable Coordinate 1
  !   Real Procedure "./bin/USF_BCs" "checkBCCount"
  ! Check Other Boundaries(1) = Integer 2

  Velocity 2 = Real 0.0
  Velocity 2 Condition = Variable Elevation
    Real MATC "-(tx-1.0)"

  Velocity 3 = Real 0.0
  Velocity 3 Condition = Variable Elevation
    Real MATC "-(tx-1.0)"

  Slip Coefficient 2 = Variable Coordinate 1
      Real MATC "if(tx>-197086){1.0e-3}else{1.0e-2}"

  Slip Coefficient 3 = Variable Coordinate 1
      Real MATC "if(tx>-197086){1.0e-3}else{1.0e-2}"

  ! Temp = Variable Coordinate 1
  !   Real Procedure "./bin/USF_Grid2DInterpolator" "TempInterp"
  ! Include "temp.xyz.header"

  Longitudinal Mesh Update 1 = Real 0.0
  Longitudinal Mesh Update 2 = Real 0.0
  Longitudinal Mesh Update 3 = Real 0.0

!   Zs Top = Equals Reference Zs Top
  Zs Bottom = Equals Reference Zs Bottom

  Remesh Update 3 = Real 0.0
End

Boundary Condition 4

  name = "Sidewalls"
  Left Sidewall Mask = Logical True
  Target Boundaries = 4
  Flow Force BC = Logical True

  Normal-Tangential Velocity = Logical True
  Normal-Tangential Flow Solution = Logical True
  Mass Consistent Normals = Logical True

  Velocity 1 = Real 0.0
  ! Velocity 1 Condition = Variable Coordinate 1
  !   Real Procedure "./bin/USF_BCs" "checkBCCount"
  ! Check Other Boundaries(1) = Integer 2

  Velocity 2 = Real 0.0
  Velocity 2 Condition = Variable Elevation
    Real MATC "-(tx-1.0)"

  Velocity 3 = Real 0.0
  Velocity 3 Condition = Variable Elevation
    Real MATC "-(tx-1.0)"

  Slip Coefficient 2 = Variable Coordinate 1
      Real MATC "if(tx>-180986){1.0e-3}else{1.0e-2}"

  Slip Coefficient 3 = Variable Coordinate 1
      Real MATC "if(tx>-180986){1.0e-3}else{1.0e-2}"

  ! Temp = Variable Coordinate 1
  !   Real Procedure "./bin/USF_Grid2DInterpolator" "TempInterp"
  ! Include "temp.xyz.header"

  Longitudinal Mesh Update 1 = Real 0.0
  Longitudinal Mesh Update 2 = Real 0.0
  Longitudinal Mesh Update 3 = Real 0.0

!   Zs Top = Equals Reference Zs Top
  Zs Bottom = Equals Reference Zs Bottom

  Remesh Update 3 = Real 0.0
End

Boundary Condition 5
  name = "bottom"
  Target Boundaries = 5
  Bottom Surface Mask = Logical True

  !This has been changed for calving remesh
  !it'd be a problem if we were still using
  !structuredmeshmapper, but we restart with
  !coords from spinup (adjoint)
  Bottom Surface = Equals RemeshBottomSurf
  ! Bottom Surface = Variable Coordinate 1
  !   Real Procedure "./bin/USF_Grid2DInterpolator" "BedInterp"

  ! Include "bed.xyz.header"
  Body ID = 2

  Flow Force BC = Logical True
  Normal-Tangential Velocity = Logical True
  Mass Consistent Normals = Logical True

  !TODO sea spring
  Velocity 1 = Real 0.0
  Velocity 1 Condition = Variable GroundedMask
    Real MATC "tx + 0.5"

  Grounding Line Definition = String "discontinuous"
  !TODO USF_Contact (homemade) for zero friction under floating
  !Need to modify USF_Contact to read from variable
  !SeaSpring currently works by checking ComputeNormal condition
  !Shouldn't it just check for the groundedmask < 0?

  Slip Coefficient 2 = Variable Coordinate 1
    Real Procedure "ElmerIceUSF" "SlidCoef_Contact"
  Slip Coefficient 3 = Variable Coordinate 1
    Real Procedure "ElmerIceUSF" "SlidCoef_Contact"

  Test Contact Tolerance = Real 1.0E-2
  Sliding Law = String "prescribed power"
  Friction Variable Name = String "beta"
  ComputeNormal Condition = Variable GroundedMask
    Real MATC "tx + 0.5"
  External Pressure = Variable Coordinate 3 !dummy
     Real Procedure "ElmerIceUSF" "SeaPressure"
  Slip Coefficient 1 = Variable Coordinate 3
    Real Procedure "ElmerIceUSF" "SeaSpring"
  Compute Sea Pressure = Logical True
  Compute Sea Spring = Logical True

  ! Temp Load = Variable Velocity 1
  !     Real Procedure  "ElmerIceUSF" "getFrictionLoads"

  ! Temp Flux BC = Logical True !(needed when geothermal flux is used)
  ! Temp Heat Flux = Variable Coordinate 1
  !	Real MATC "0.075*(31556926.0)*1.0E-06" !75mW/m2 !TODO was 40 previously

!   Mesh Update 1 = Real 0.0
!   Mesh Update 2 = Real 0.0
  ! Vertical Mesh Update 3 = Variable Zs Bottom
  !   Real Procedure "ElmerIceUSF" "ZsBottomMzsIni"
  Vertical Mesh Update 3 = Variable Zs Bottom, Reference Zs Bottom
    Real MATC "tx(0) - tx(1)"

  Longitudinal Mesh Update 3 = Real 0.0

  ! Zs Bottom = Variable Coordinate 1
  !   Real Procedure "./bin/USF_Grid2DInterpolator" "BedInterp"

  Zs Bottom = Real -500.0

  Zs Bottom Condition = Variable GroundedMask
    Real MATC "tx + 0.5"

  Elevation = Real 0.0
End

Boundary Condition 6
  name = Surface
  Top Surface Mask = Logical True
  Target Boundaries = 6

  !This has been changed for calving remesh
  !it'd be a problem if we were still using
  !structuredmeshmapper, but we restart with
  !coords from spinup (adjoint)
  Top Surface = Equals RemeshTopSurf
  ! Top Surface = Equals Zs Top

  Body ID = 3

  Normal-Tangential V = Logical True
  Normal-Tangential Velocity = Logical True
  Normal-Tangential Flow Solution = Logical True

  Depth = Real 0.0
  Flow Force BC = Logical True

  ! Temp = Variable Coordinate 1
  !   Real Procedure "./bin/USF_Grid2DInterpolator" "TempInterp"
  ! Include "temp.xyz.header"
  ! Include "smb.xyz.header"

!   Mesh Update 1 = Real 0.0
!   Mesh Update 2 = Real 0.0
  ! Vertical Mesh Update 3 = Variable Zs Top
  !   Real Procedure "ElmerIceUSF" "ZsTopMzsIni"
  Vertical Mesh Update 3 = Variable Zs Top, Reference Zs Top
    Real MATC "tx(0) - tx(1)"

  Longitudinal Mesh Update 3 = Real 0.0
End


Body Force 1
  Flow BodyForce 1 = Real 0.0
  Flow BodyForce 2 = Real 0.0
  Flow BodyForce 3 = Real $-g

  ! ! Temp Volume Source = Equals W ! The volumetric heat source
  ! Temp Homologous = Variable Temp
  !   Real Procedure "./bin/USF_BCs" "TempHom"

  Vertical Mesh Update 2 = Real 0.0
  Vertical Mesh Update 1 = Real 0.0

  Remesh Update 1 = Real 0.0
  Remesh Update 2 = Real 0.0
End

Body Force 2
  !! melting/accretion under ice/shelf
  !! positive for melting
  !! negative for accretion

  Zs Bottom Accumulation = Variable BasalMeltRate
    Real MATC "tx"
End

Body Force 3
  ! smb = Variable Coordinate 1
  !   Real Procedure "./bin/USF_Grid2DInterpolator" "SmbInterp"
  ! Zs Top Accumulation Flux 3 = Variable smb
  !   Real MATC "tx(0) * (RhoFW/Rho)"
End

Body Force 4
End

Initial Condition 1
!   Depth = Real 0.0
!   Height = Real 0.0

!   Pressure = Real 0.0
!   Velocity 1 = Real 0.0
!   Velocity 2 = Real 0.0
!   Velocity 3 = Real 0.0

!   ! Flow Solution 1 = Real 0.0
!   ! Flow Solution 2 = Real 0.0
!   ! Flow Solution 3 = Real 0.0
End

Initial Condition 2
 ! Zs Bottom = Variable Coordinate 1
 !    Real Procedure "./bin/USF_Grid2DInterpolator" "BedInterp"

 ! Reference Zs Bottom = Variable Coordinate 1
 !    Real Procedure "./bin/USF_Grid2DInterpolator" "BedInterp"

 Zs Bottom = Equals Coordinate 3
 Reference Zs Bottom = Equals Coordinate 3
End

Initial Condition 3
  Zs Top = Equals Coordinate 3
  Reference Zs Top = Equals Coordinate 3
End

Initial Condition 4
   !The initial value of FreeSurface and 'Reference FreeSurface'
   !are set by FreeSurfaceSolver_RefInit.
End